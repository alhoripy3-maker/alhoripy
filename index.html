<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>الحريبي | كتالوج وطلبات قطع غيار الدراجات النارية</title>
  <style>
    :root{--accent:#0b6b4f;--muted:#6b6b6b;--del:#e74c3c;--edit:#f39c12}
    *{box-sizing:border-box}
    body{font-family:Tahoma,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    header{background:var(--accent);color:#fff;padding:8px 18px;display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0;display:flex;align-items:center;gap:12px}
    header h1 img{height:40px;margin-left:8px}
    .container{max-width:1100px;margin:18px auto;padding:12px}
    .layout{display:flex;gap:18px}
    .sidebar{width:260px;background:#fff;border:1px solid #e3e6ee;padding:12px;border-radius:8px;height:calc(100vh - 140px);overflow:auto}
    .main{flex:1}
    .category{padding:10px;border-radius:6px;border:1px dashed #e0e0e0;margin-bottom:8px;cursor:pointer}
    .category.active{background:#eef9f2;border-style:solid}
    .items{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .card{background:#fff;border:1px solid #e6e7ef;padding:8px;border-radius:8px;text-align:center}
    .card img{width:100%;height:120px;object-fit:contain;background:#fafafa;border-radius:6px}
    .card h4{margin:8px 0 6px;font-size:14px}
    .card p{margin:0;color:var(--muted);font-size:13px}
    .qty{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:8px}
    .btn{display:inline-block;padding:8px 12px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
    .order-panel{background:#fff;border:1px solid #e6e7ef;padding:12px;border-radius:8px}
    label{display:block;margin-top:8px;font-size:13px}
    input,textarea,select{width:100%;padding:8px;margin-top:6px;border:1px solid #d8d9e0;border-radius:6px}
    .flex{display:flex;gap:8px}
    .flex .col{flex:1}
    footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .admin-link{background:#fff;color:var(--accent);padding:6px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);cursor:pointer}
    .items-empty{padding:30px;background:#fff;border-radius:8px;border:1px dashed #e7e7ee;text-align:center;color:var(--muted)}
    .badge{background:#f1f8f5;color:#066644;padding:4px 8px;border-radius:20px;font-size:12px}
    .price{font-weight:bold;color:#111;margin-bottom:8px;display:block;}

    /* admin modal layout */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; padding:20px; z-index:9999; }
    .admin-box { background:#fff; width:100%; max-width:980px; border-radius:8px; padding:16px; direction:rtl; position:relative; }
    .admin-close { position:absolute; left:12px; top:12px; padding:6px 10px; cursor:pointer; border:none; background:#eee; border-radius:6px; }
    .admin-columns{ display:flex; gap:12px; }
    .admin-col-left{ width:260px; border-right:1px solid #eef0f3; padding-right:12px; }
    .admin-col-right{ flex:1; padding-left:12px; max-height:60vh; overflow:auto; }
    .admin-categ-row{ display:flex; align-items:center; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #f0f0f0; }
    .admin-item-row{ display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #f0f0f0; }
    .thumb{ width:56px; height:40px; object-fit:cover; border-radius:6px; border:1px solid #eee; background:#fafafa; margin-left:8px; }

    /* small form buttons */
    .small-btn { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; margin-left:6px; }
    .small-btn.edit { background:var(--edit); color:#fff; }
    .small-btn.del { background:var(--del); color:#fff; }
    .small-btn.add { background:var(--accent); color:#fff; }

    /* specific modal styling */
    .form-modal .admin-box { max-width: 480px; padding: 24px; text-align: right; }
    .form-modal .admin-box .form-buttons { margin-top: 16px; display: flex; gap: 8px; }
    .form-modal .admin-box .form-buttons .btn { flex: 1; }
    .form-modal .admin-close { background-color: #f44336; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; text-align: center; padding: 0; font-size: 18px; top: 12px; left: 12px; }
    .form-modal .admin-close:hover { background-color: #d32f2f; }
    
    /* Media queries for responsiveness */
    @media (max-width: 900px) {
        .layout {
            flex-direction: column;
        }
        .sidebar {
            width: 100%;
            height: auto;
            border-bottom: 1px solid #e3e6ee;
        }
        .admin-columns {
            flex-direction: column;
        }
        .admin-col-left {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #eef0f3;
            padding-bottom: 8px;
            padding-right: 0;
        }
        .admin-col-right {
            padding-left: 0;
            padding-top: 12px;
            max-height: none;
            overflow: visible;
        }
        .modal .admin-box {
            max-height: 90vh;
            overflow-y: auto;
            padding: 12px;
        }
        header h1 {
            font-size: 16px;
        }
        .top-actions {
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhkdHyUkHyUdLTUrJzJzYwYHBsYlJrYfGsiD+zX/2wBDAQcHBwYMCgcMDgsKEhIQChEVEhISEhUVDhQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU/8AAEQgAQACQAwERAAIRAQMRAf/EAB4AAAEFAQEBAQAAAAAAAAAAAAAHBQYICAMJAgsK/8QAMhAAAQMCAwUEAQMDBQEBAAAAAgEDBAAHBRIRBhMhIhQxQQgUMlEVFjRhkzJicYEjcrH/xAAZAQEBAQEBAQAAAAAAAAAAAAADAgQFBgD/xAAgEQACAQQDAQEBAQAAAAAAAAAAAQIDBAURFSAxBhITQf/aAAgBAwEBPwD+zWv8A5v8A162r/jH6vV723f8AT9W1/wAd6A2+rf/f6tv/j/AEo2r/jdKduf4vpr/b/APd+gG1k3/n9W1f8b63euf/f62r/jfQG3/AFofSgO1w/8A/a5/qE+gP/9k=" alt="ALHORIPY Logo" />
      الحريبي | كتالوج وطلبات قطع غيار الدراجات النارية
    </h1>
    <div class="top-actions">
      <div class="badge" id="ordersCount">0 طلب محفوظ</div>
      <button class="admin-link" id="btnAdmin">لوحة التحكم (Admin)</button>
    </div>
  </header>

  <div class="container">
    <div class="layout">
      <aside class="sidebar">
        <h3>التصنيفات</h3>
        <div id="categoriesList"></div>
        <hr />
        <h4>بحث سريع</h4>
        <input id="search" placeholder="ابحث عن صنف أو كلمة..." />
        <div style="margin-top:10px">
          <button class="btn" id="btnClear">إفراغ السلة</button>
        </div>
      </aside>

      <main class="main">
        <section>
          <h2 id="catTitle">كل الأقسام</h2>
          <div id="itemsWrap" class="items"></div>
          <div id="itemsEmpty" class="items-empty" style="display:none">لم يتم العثور على أصناف.</div>
        </section>

        <section style="margin-top:12px">
          <div class="order-panel">
            <h3>نموذج طلب الشراء</h3>
            <div id="orderList"></div>

            <hr />
            <form id="orderForm" onsubmit="return false">
              <label>الاسم</label>
              <input id="clientName" placeholder="الاسم الكامل" />
              <label>اسم المحل (إلزامي)</label>
              <input id="shopName" placeholder="اسم المحل" required />
              <div class="flex">
                <div class="col">
                  <label>العنوان</label>
                  <input id="address" placeholder="المدينة - الحي" />
                </div>
                <div class="col">
                  <label>رقم الهاتف</label>
                  <input id="phone" placeholder="05xxxxxxxx" />
                </div>
              </div>

              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn" id="btnSaveOrder">حفظ الطلب</button>
                <button class="btn ghost" id="btnDownloadCSV">تنزيل Excel (CSV)</button>
                <button class="btn ghost" id="btnDownloadPDF">تنزيل PDF</button>
                <button class="btn ghost" id="btnWhatsApp">إرسال إلى واتساب</button>
                <button class="btn ghost" id="btnEmail">إرسال عبر الإيميل</button>
                <button class="btn ghost" id="btnPrint">طباعة</button>
              </div>
            </form>
          </div>
        </section>
      </main>
    </div>
  </div>

  <footer>صُمّم لتلبية احتياجات متجر الحريبي لقطع غيار الدراجات النارية — نسخة محلية تعمل بدون خادم (تخزين محلي)</footer>

  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="admin-box" role="dialog" aria-modal="true">
      <button id="adminClose" class="admin-close">إغلاق</button>

      <div id="loginBox">
        <h3>تسجيل دخول مسؤول</h3>
        <label>اسم المستخدم</label>
        <input id="adminUser" value="" />
        <label>كلمة المرور</label>
        <input id="adminPass" value="" type="password" />
        <div style="margin-top:8px">
          <button class="btn" id="btnLoginAdmin">دخول</button>
        </div>
      </div>

      <div id="controlPanel" style="display:none">
        <h3>لوحة إدارة الكتالوج</h3>
        <div class="admin-columns">
          <div class="admin-col-left">
            <h4>التصنيفات</h4>
            <div id="adminCategories"></div>
            <div style="margin-top:8px">
              <input id="newCategoryName" placeholder="اسم تصنيف جديد" />
              <button class="small-btn add" id="addCategoryBtn">إضافة تصنيف</button>
            </div>
          </div>

          <div class="admin-col-right">
            <h4>الأصناف</h4>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <label style="min-width:110px">اختر تصنيف:</label>
              <select id="selectCatForItem" style="flex:1"></select>
              <button class="small-btn add" id="openAddItem">➕ إضافة صنف</button>
            </div>

            <div id="adminItems"></div>

            <hr />
            <h4>الطلبات المحفوظة</h4>
            <div id="savedOrdersAdmin"></div>

            <div style="margin-top:10px;">
              <button class="btn ghost" id="btnLogout">تسجيل خروج</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="itemModal" class="modal form-modal" aria-hidden="true">
    <div class="admin-box">
      <button class="admin-close" onclick="document.getElementById('itemModal').style.display='none'">&times;</button>
      <h3 id="itemModalTitle">إضافة صنف</h3>
      <label>التصنيف</label>
      <select id="itemModalCategory"></select>
      <label>اسم الصنف</label>
      <input id="itemModalName" />
      <label>الوصف (اختياري)</label>
      <input id="itemModalDesc" />
      <label>السعر (اختياري)</label>
      <input id="itemModalPrice" type="text" pattern="[0-9]*" inputmode="numeric" />
      <label>صورة الصنف (تحميل محلي)</label>
      <input id="itemModalImage" type="file" accept="image/*" />
      <div class="form-buttons">
        <button class="btn" id="saveItemBtn">حفظ</button>
        <button class="btn ghost" id="cancelItemBtn" onclick="document.getElementById('itemModal').style.display='none'">إلغاء</button>
      </div>
    </div>
  </div>

  <div id="categoryModal" class="modal form-modal" aria-hidden="true">
    <div class="admin-box">
      <button class="admin-close" onclick="document.getElementById('categoryModal').style.display='none'">&times;</button>
      <h3 id="categoryModalTitle">إضافة تصنيف</h3>
      <label>اسم التصنيف</label>
      <input id="categoryModalName" />
      <div class="form-buttons">
        <button class="btn" id="saveCategoryBtn">حفظ</button>
        <button class="btn ghost" id="cancelCategoryBtn" onclick="document.getElementById('categoryModal').style.display='none'">إلغاء</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    //======================================================================
    // تم إضافة هذه الأسطر الجديدة لتهيئة Supabase
    // يرجى استبدال هذه القيم ببيانات مشروعك
    //======================================================================
  const SUPABASE_URL = 'https://muwylrqdcrzggqbxhmoq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im11d3lscnFkY3J6Z2dxYnhobW9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NjUzOTcsImV4cCI6MjA3MTI0MTM5N30.vO-mMw4TULYO62dNgw_lRe8NoMd9SW6SDOwjr5r83Zo';

    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Storage keys (لم تعد تستخدم)
    const LS_CATALOG = 'horipy_catalog_v1';
    const LS_ORDERS = 'horipy_orders_v1';
    const LS_ADMIN = 'horipy_admin_v1';

    // Default catalog (لم تعد تستخدم)
    const defaultCatalog = {
      categories:[],
      items:[]
    };

    // utils
    function uid(){return 'id'+Math.random().toString(36).slice(2,9)}
    // لم تعد وظائف التخزين المحلي هذه تُستخدم
    // function saveCatalog(c){ localStorage.setItem(LS_CATALOG, JSON.stringify(c)); }
    // function loadCatalog(){ const r = localStorage.getItem(LS_CATALOG); return r? JSON.parse(r) : JSON.parse(JSON.stringify(defaultCatalog)); }
    // function saveOrders(o){ localStorage.setItem(LS_ORDERS, JSON.stringify(o)); }
    // function loadOrders(){ const r = localStorage.getItem(LS_ORDERS); return r? JSON.parse(r) : []; }
    // function loadAdmin(){ const r=localStorage.getItem(LS_ADMIN); return r? JSON.parse(r) : {user:'admin',pass:'213626'} }

    // state
    let catalog = { categories: [], items: [] };
    let orders = [];
    let currentCat = null;
    let cart = [];

    // admin modal elements
    const adminModal = document.getElementById('adminModal');
    const adminCloseBtn = document.getElementById('adminClose');
    const btnAdmin = document.getElementById('btnAdmin');
    const loginBox = document.getElementById('loginBox');
    const controlPanel = document.getElementById('controlPanel');
    const btnLoginAdmin = document.getElementById('btnLoginAdmin');
    const btnLogout = document.getElementById('btnLogout');
    const adminCategories = document.getElementById('adminCategories');
    const selectCatForItem = document.getElementById('selectCatForItem');
    const adminItems = document.getElementById('adminItems');
    const newCategoryName = document.getElementById('newCategoryName');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const openAddItemBtn = document.getElementById('openAddItem');
    const savedOrdersAdmin = document.getElementById('savedOrdersAdmin');

    // item modal
    const itemModal = document.getElementById('itemModal');
    const itemModalTitle = document.getElementById('itemModalTitle');
    const itemModalCategory = document.getElementById('itemModalCategory');
    const itemModalName = document.getElementById('itemModalName');
    const itemModalDesc = document.getElementById('itemModalDesc');
    const itemModalPrice = document.getElementById('itemModalPrice');
    const itemModalImage = document.getElementById('itemModalImage');
    const saveItemBtn = document.getElementById('saveItemBtn');

    // category modal
    const categoryModal = document.getElementById('categoryModal');
    const categoryModalTitle = document.getElementById('categoryModalTitle');
    const categoryModalName = document.getElementById('categoryModalName');
    const saveCategoryBtn = document.getElementById('saveCategoryBtn');

    // helper flags
    let adminLogged = false;
    let editingItemId = null; // id of item being edited
    let editingCategoryId = null; // id of category being edited

    // DOM nodes for main UI
    const categoriesList = document.getElementById('categoriesList');
    const itemsWrap = document.getElementById('itemsWrap');
    const itemsEmpty = document.getElementById('itemsEmpty');
    const catTitle = document.getElementById('catTitle');
    const orderList = document.getElementById('orderList');
    const ordersCount = document.getElementById('ordersCount');

    //======================================================================
    // تم تعديل وظائف جلب البيانات من Supabase
    //======================================================================
    async function fetchCatalog() {
      const { data: categories, error: catError } = await supabase.from('categories').select('*');
      const { data: items, error: itemError } = await supabase.from('items').select('*');
      if (catError || itemError) {
        console.error('Error fetching catalog:', catError || itemError);
        return { categories: [], items: [] };
      }
      return { categories, items };
    }

    async function fetchOrders() {
      const { data, error } = await supabase.from('orders').select('*');
      if (error) {
        console.error('Error fetching orders:', error);
        return [];
      }
      return data;
    }

    // render categories sidebar (main UI)
    async function renderCategories(filter='') {
      const { categories } = await fetchCatalog();
      catalog.categories = categories;

      categoriesList.innerHTML = '';
      const allBtn = document.createElement('div');
      allBtn.className = 'category' + (currentCat===null ? ' active' : '');
      allBtn.textContent = 'كل الأقسام';
      allBtn.onclick = async ()=>{ currentCat=null; await renderItems(); renderCategories(); };
      categoriesList.appendChild(allBtn);

      catalog.categories.forEach(c=>{
        if(filter && !c.name.includes(filter)) return;
        const d = document.createElement('div');
        d.className = 'category' + (currentCat===c.id ? ' active' : '');
        d.textContent = c.name;
        d.onclick = async ()=>{ currentCat = c.id; await renderItems(); renderCategories(); };
        categoriesList.appendChild(d);
      });
    }

    // render items grid (main UI)
    async function renderItems() {
      const { items } = await fetchCatalog();
      catalog.items = items;

      itemsWrap.innerHTML = '';
      const searchQ = document.getElementById('search').value.trim();
      let found = 0;
      const filteredItems = catalog.items.filter(it=>{
        if(currentCat && it.cat !== currentCat) return false;
        if(searchQ){ const q = searchQ.toLowerCase(); return (it.name||'').toLowerCase().includes(q) || (it.desc||'').toLowerCase().includes(q); }
        return true;
      });

      filteredItems.forEach(it=>{
        found++;
        const card = document.createElement('div'); card.className='card';
        const img = document.createElement('img'); img.src = it.img || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"><rect width="100%" height="100%" fill="%23fafafa"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%236b6b6b" font-size="16">صورة غير متوفرة</text></svg>';
        const h4 = document.createElement('h4'); h4.textContent = it.name;
        const p = document.createElement('p'); p.textContent = it.desc || '';
        const price = document.createElement('span'); price.className='price'; price.textContent = it.price ? `السعر: ${it.price}` : '';
        const qtyDiv = document.createElement('div'); qtyDiv.className='qty';
        const minus = document.createElement('button'); minus.textContent='-'; minus.className='btn ghost';
        const inputQty = document.createElement('input'); inputQty.type='number'; inputQty.min=1; inputQty.value=1; inputQty.style.width='70px';
        const plus = document.createElement('button'); plus.textContent='+'; plus.className='btn ghost';
        const addBtn = document.createElement('button'); addBtn.textContent='أضف إلى الطلب'; addBtn.className='btn';
        minus.onclick = ()=>{ inputQty.value = Math.max(1, Number(inputQty.value)-1); };
        plus.onclick = ()=>{ inputQty.value = Number(inputQty.value) + 1; };
        addBtn.onclick = ()=>{ addToCart(it, Number(inputQty.value)); };
        qtyDiv.appendChild(minus); qtyDiv.appendChild(inputQty); qtyDiv.appendChild(plus);
        card.appendChild(img); card.appendChild(h4); card.appendChild(p); card.appendChild(price); card.appendChild(qtyDiv); card.appendChild(addBtn);

        // if admin logged in show small admin controls on card (optional)
        if(adminLogged){
          const adminControls = document.createElement('div'); adminControls.style.marginTop = '8px';
          const editBtn = document.createElement('button'); editBtn.className='btn ghost'; editBtn.textContent='تعديل';
          editBtn.onclick = ()=>{ openItemModalForEdit(it.id); };
          const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.textContent='حذف';
          delBtn.onclick = async ()=>{ if(confirm('حذف الصنف؟')){ await deleteItem(it.id); } };
          adminControls.appendChild(editBtn); adminControls.appendChild(delBtn);
          card.appendChild(adminControls);
        }

        itemsWrap.appendChild(card);
      });

      itemsEmpty.style.display = found ? 'none' : 'block';
      catTitle.textContent = currentCat ? (catalog.categories.find(c=>c.id===currentCat)||{}).name : 'كل الأقسام';
    }

    // cart functions
    function addToCart(item, qty){
      const existing = cart.find(c=>c.id===item.id);
      if(existing) existing.qty += qty;
      else cart.push({ id:item.id, name:item.name, desc:item.desc, price:item.price, qty:qty, cat:item.cat });
      renderOrder();
    }

    function renderOrder(){
      orderList.innerHTML = '';
      if(cart.length===0){ orderList.innerHTML = '<div class="small">السلة فارغة. أضف أصناف من الكتالوج.</div>'; return; }
      
      let totalValue = 0;
      const listDiv = document.createElement('div');
      
      cart.forEach((c, idx)=>{
        const itemValue = parseFloat(c.price || 0) * c.qty;
        totalValue += itemValue;
        
        const row = document.createElement('div'); 
        row.style.display='grid'; 
        row.style.gridTemplateColumns='1fr 80px 80px 100px'; 
        row.style.alignItems='center'; 
        row.style.gap='10px';
        row.style.padding='8px 0';
        row.style.borderBottom = '1px dashed #f0f0f0';

        const nameDiv = document.createElement('div');
        nameDiv.innerHTML = `<b>${c.name}</b><div class="small">${c.desc||''}</div>`;
        
        const priceDiv = document.createElement('div');
        priceDiv.textContent = `${c.price || '0'} ر.س`;

        const qtyDiv = document.createElement('div');
        const minus = document.createElement('button'); minus.textContent='-'; minus.className='btn ghost';
        minus.style.padding = '4px 6px';
        const q = document.createElement('span'); q.style.margin='0 4px'; q.textContent = c.qty;
        const plus = document.createElement('button'); plus.textContent='+'; plus.className='btn ghost';
        plus.style.padding = '4px 6px';
        minus.onclick = ()=>{ c.qty = Math.max(1, c.qty-1); renderOrder(); };
        plus.onclick = ()=>{ c.qty++; renderOrder(); };
        qtyDiv.appendChild(minus); qtyDiv.appendChild(q); qtyDiv.appendChild(plus);

        const valueDiv = document.createElement('div');
        valueDiv.textContent = `${itemValue.toFixed(2)} ر.س`;
        
        const delBtn = document.createElement('button');
        delBtn.textContent='حذف';
        delBtn.className='small-btn del';
        delBtn.onclick = ()=>{ cart.splice(idx,1); renderOrder(); };

        row.appendChild(nameDiv);
        row.appendChild(priceDiv);
        row.appendChild(qtyDiv);
        row.appendChild(valueDiv);
        row.appendChild(delBtn);

        listDiv.appendChild(row);
      });
      
      const totalRow = document.createElement('div');
      totalRow.style.display='flex';
      totalRow.style.justifyContent='space-between';
      totalRow.style.alignItems='center';
      totalRow.style.marginTop='10px';
      totalRow.innerHTML = `<h4 style="margin:0;">إجمالي الطلب:</h4><h4 style="margin:0;color:var(--accent);">${totalValue.toFixed(2)} ر.س</h4>`;
      listDiv.appendChild(totalRow);
      
      orderList.appendChild(listDiv);
    }

    // order actions (buttons)
    //======================================================================
    // تم تعديل وظيفة حفظ الطلب لحفظه في Supabase
    //======================================================================
    document.getElementById('btnSaveOrder').onclick = async ()=>{
      const name = document.getElementById('clientName').value.trim();
      const shop = document.getElementById('shopName').value.trim();
      const address = document.getElementById('address').value.trim();
      const phone = document.getElementById('phone').value.trim();
      if(!shop){ alert('يرجى إدخال اسم المحل (الحقل الإلزامي)'); return; }
      if(cart.length===0){ alert('السلة فارغة'); return; }

      const order = { name, shop, address, phone, items: cart.slice() };
      const { data, error } = await supabase.from('orders').insert([order]);
      
      if(error){
        console.error('Error saving order:', error);
        alert('حدث خطأ أثناء حفظ الطلب. يرجى المحاولة مرة أخرى.');
      } else {
        orders.push(order);
        cart=[];
        renderOrder();
        await updateOrdersCount();
        alert('تم حفظ الطلب بنجاح');
      }
    };

    document.getElementById('btnDownloadCSV').onclick = ()=>{
      if(prepareOrderAndValidate()) return;
      const obj = buildOrderObject();
      const rows = [['الاسم','اسم المحل','العنوان','الهاتف','تاريخ','اسم الصنف','الكمية','السعر','القيمة','ملاحظة']];
      obj.items.forEach(it=> rows.push([obj.name,obj.shop,obj.address,obj.phone,obj.date,it.name,it.qty,it.price,it.value,it.desc||'']));
      rows.push(['','','','','','','','','إجمالي الطلب: '+obj.totalValue+' ر.س','']);
      const csv = rows.map(r=> r.map(c=> '"'+String(c||'').replace(/"/g,'""')+'"').join(',') ).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'order_'+(new Date().toISOString().slice(0,19))+'.csv'; a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('btnDownloadPDF').onclick = async ()=>{
      if(prepareOrderAndValidate()) return;
      const obj = buildOrderObject();
      const el = document.createElement('div'); el.style.direction='rtl'; el.style.padding='12px'; el.style.fontFamily='Tahoma,Arial';
      el.innerHTML = `<h2>طلب شراء - ${obj.shop}</h2><div>التاريخ: ${obj.date}</div><div>الاسم: ${obj.name||''}</div><div>العنوان: ${obj.address||''}</div><div>الهاتف: ${obj.phone||''}</div><hr/><h4>الأصناف:</h4><ol>${obj.items.map(it=>`<li><b>${it.name}</b> (الكمية: ${it.qty}, السعر: ${it.price || '0'} ر.س, القيمة: ${it.value} ر.س)</li>`).join('')}</ol><hr/><h3>إجمالي الطلب: ${obj.totalValue} ر.س</h3>`;
      document.body.appendChild(el);
      const canvas = await html2canvas(el,{scale:2});
      const imgData = canvas.toDataURL('image/png'); document.body.removeChild(el);
      const { jsPDF } = window.jspdf; const pdf = new jsPDF({unit:'pt',format:'a4'});
      const imgProps = pdf.getImageProperties(imgData); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight); pdf.save('order_'+(new Date().toISOString().slice(0,19))+'.pdf');
    };

    document.getElementById('btnWhatsApp').onclick = ()=>{
      if(prepareOrderAndValidate()) return;
      const obj = buildOrderObject(); const lines = [];
      lines.push('طلب شراء - متجر الحريبي'); lines.push('اسم المحل: '+obj.shop);
      if(obj.name) lines.push('الاسم: '+obj.name); if(obj.address) lines.push('العنوان: '+obj.address); if(obj.phone) lines.push('الهاتف: '+obj.phone);
      lines.push('---الأصناف---'); obj.items.forEach(it=>lines.push(`${it.name} (كمية: ${it.qty}, سعر: ${it.price || '0'}, قيمة: ${it.value})`));
      lines.push(`\nإجمالي الطلب: ${obj.totalValue} ر.س`);
      const text = encodeURIComponent(lines.join('\n')); const phone = '967776438571'; const url = 'https://wa.me/'+phone+'?text='+text; window.open(url,'_blank');
    };

    document.getElementById('btnEmail').onclick = ()=>{
      if(prepareOrderAndValidate()) return;
      const obj = buildOrderObject(); const lines = [];
      lines.push('طلب شراء - متجر الحريبي'); lines.push('اسم المحل: '+obj.shop);
      if(obj.name) lines.push('الاسم: '+obj.name); if(obj.address) lines.push('العنوان: '+obj.address); if(obj.phone) lines.push('الهاتف: '+obj.phone);
      lines.push('---الأصناف---'); obj.items.forEach(it=>lines.push(`${it.name} (كمية: ${it.qty}, سعر: ${it.price || '0'}, قيمة: ${it.value})`));
      lines.push(`\nإجمالي الطلب: ${obj.totalValue} ر.س`);
      const subject = encodeURIComponent('طلب شراء - '+obj.shop); const body = encodeURIComponent(lines.join('\n'));
      window.location.href = 'mailto:alhoripy18@gmail.com?subject='+subject+'&body='+body;
    };

    document.getElementById('btnPrint').onclick = ()=>{
      if(prepareOrderAndValidate()) return;
      const obj = buildOrderObject(); const w = window.open('about:blank','printwin');
      w.document.write('<html dir="rtl"><head><meta charset="utf-8"><title>طباعة الطلب</title></head><body style="font-family:Tahoma; padding: 20px;">');
      w.document.write('<h2>طلب شراء - '+escapeHtml(obj.shop)+'</h2>'); w.document.write('<div>التاريخ: '+obj.date+'</div>');
      if(obj.name) w.document.write('<div>الاسم: '+escapeHtml(obj.name)+'</div>'); if(obj.address) w.document.write('<div>العنوان: '+escapeHtml(obj.address)+'</div>');
      if(obj.phone) w.document.write('<div>الهاتف: '+escapeHtml(obj.phone)+'</div>'); w.document.write('<hr><h4>الأصناف:</h4><ol>');
      obj.items.forEach(it=> w.document.write(`<li><b>${escapeHtml(it.name)}</b> (الكمية: ${it.qty}, السعر: ${it.price || '0'} ر.س, القيمة: ${it.value} ر.س)</li>`));
      w.document.write('</ol><hr><h3>إجمالي الطلب: '+obj.totalValue+' ر.س</h3></body></html>'); w.document.close(); w.print();
    };

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
    function prepareOrderAndValidate(){ const shop = document.getElementById('shopName').value.trim(); if(!shop){ alert('اسم المحل مطلوب'); return true } if(cart.length===0){ alert('السلة فارغة'); return true } return false }
    function buildOrderObject(){ 
        let totalValue = 0;
        const items = cart.map(c=>{
          const value = parseFloat(c.price || 0) * c.qty;
          totalValue += value;
          return { name: c.name, qty: c.qty, desc: c.desc, price: c.price, value: value.toFixed(2) };
        });
        return { 
          date:new Date().toLocaleString('ar-EG'), 
          name:document.getElementById('clientName').value.trim(), 
          shop:document.getElementById('shopName').value.trim(), 
          address:document.getElementById('address').value.trim(), 
          phone:document.getElementById('phone').value.trim(), 
          items,
          totalValue: totalValue.toFixed(2)
        } 
    }

    // ===== Admin logic =====
    btnAdmin.addEventListener('click', ()=> { openAdminModal(); });

    function openAdminModal(){
      adminModal.style.display = 'flex';
      loginBox.style.display = 'block';
      controlPanel.style.display = 'none';
      document.getElementById('adminUser').value = '';
      document.getElementById('adminPass').value = '';
    }
    adminCloseBtn.addEventListener('click', ()=>{ adminModal.style.display='none'; });

    //======================================================================
    // تم تعديل وظيفة تسجيل الدخول
    //======================================================================
    btnLoginAdmin.addEventListener('click', async ()=>{ await loginAdmin(); });
    btnLogout.addEventListener('click', ()=>{ loginBox.style.display='block'; controlPanel.style.display='none'; adminLogged=false; renderItems(); });

    async function loginAdmin(){
      const u = document.getElementById('adminUser').value;
      const p = document.getElementById('adminPass').value;
      
      const { data, error } = await supabase
        .from('admins')
        .select('*')
        .eq('user', u)
        .eq('pass', p);
        
      if(error || !data || data.length === 0){
        alert('بيانات دخول خاطئة');
      } else {
        adminLogged = true;
        loginBox.style.display = 'none';
        controlPanel.style.display = 'block';
        await populateAdmin();
      }
    }

    // Populate admin panel lists
    //======================================================================
    // تم تحديث هذه الوظيفة لجلب البيانات من Supabase
    //======================================================================
    async function populateAdmin(){
      const { categories, items } = await fetchCatalog();
      orders = await fetchOrders();

      catalog.categories = categories;
      catalog.items = items;

      // categories
      adminCategories.innerHTML = '';
      selectCatForItem.innerHTML = '';
      catalog.categories.forEach(cat=>{
        const row = document.createElement('div'); row.className='admin-categ-row';
        const left = document.createElement('div'); left.textContent = cat.name;
        const right = document.createElement('div');
        const editBtn = document.createElement('button'); editBtn.className='small-btn edit'; editBtn.textContent='✏'; editBtn.title='تعديل التصنيف';
        editBtn.onclick = ()=>{ openCategoryModal('edit', cat.id); };
        const delBtn = document.createElement('button'); delBtn.className='small-btn del'; delBtn.textContent='🗑'; delBtn.title='حذف التصنيف';
        delBtn.onclick = async ()=>{ if(confirm('حذف التصنيف سيحذف الأصناف التابعة له. متابعة؟')){ await deleteCategory(cat.id); } };
        right.appendChild(editBtn); right.appendChild(delBtn);
        row.appendChild(left); row.appendChild(right);
        adminCategories.appendChild(row);

        // add to select
        const opt = document.createElement('option'); opt.value = cat.id; opt.textContent = cat.name; selectCatForItem.appendChild(opt);
      });

      // items grouped by category
      renderAdminItems();

      // orders
      renderSavedOrdersAdmin();
      await updateOrdersCount();
      renderItems(); // to show admin controls on cards
    }

    function renderAdminItems(){
      adminItems.innerHTML = '';
      catalog.categories.forEach(cat=>{
        const h = document.createElement('h4'); h.textContent = cat.name; adminItems.appendChild(h);
        catalog.items.filter(it=>it.cat===cat.id).forEach((it, idx)=>{
          const div = document.createElement('div'); div.className='admin-item-row';
          const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';
          const thumb = document.createElement('img'); thumb.className='thumb'; thumb.src = it.img || 'data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"160\" height=\"100\"><rect width=\"100%\" height=\"100%\" fill=\"%23fafafa\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"%236b6b6b\" font-size=\"12\">صورة</text></svg>';
          const txt = document.createElement('div'); txt.innerHTML = `<b>${it.name}</b><div class="small">${it.desc||''}</div>`;
          left.appendChild(thumb); left.appendChild(txt);
          const right = document.createElement('div');
          const editBtn = document.createElement('button'); editBtn.className='small-btn edit'; editBtn.textContent='تعديل'; editBtn.onclick = ()=>{ openItemModalForEdit(it.id); };
          const delBtn = document.createElement('button'); delBtn.className='small-btn del'; delBtn.textContent='حذف'; delBtn.onclick = async ()=>{ if(confirm('حذف الصنف؟')){ await deleteItem(it.id); } };
          right.appendChild(editBtn); right.appendChild(delBtn);
          div.appendChild(left); div.appendChild(right);
          adminItems.appendChild(div);
        });
      });
    }

    function renderSavedOrdersAdmin(){
      savedOrdersAdmin.innerHTML = '';
      if(orders.length===0){ savedOrdersAdmin.innerHTML = '<div class="small">لا توجد طلبات محفوظة</div>'; return; }
      orders.forEach(o=>{
        const d = document.createElement('div'); d.style.border='1px solid #eee'; d.style.padding='8px'; d.style.marginTop='6px';
        d.innerHTML = `<b>${o.shop}</b> <div class="small">${o.date} - ${o.name||''} - ${o.phone||''}</div>`;
        const view = document.createElement('button'); view.className='small-btn'; view.textContent='عرض'; view.onclick = ()=>{ alert(formatOrderForDisplay(o)); };
        const del = document.createElement('button'); del.className='small-btn del'; del.textContent='حذف'; del.onclick = async ()=>{ if(confirm('حذف الطلب؟')){ await deleteOrder(o.id); } };
        d.appendChild(view); d.appendChild(del);
        savedOrdersAdmin.appendChild(d);
      });
    }
    function formatOrderForDisplay(o){ 
        let text = `اسم المحل: ${o.shop}\nالتاريخ: ${o.created_at ? new Date(o.created_at).toLocaleString('ar-EG') : 'غير متوفر'}\nالاسم: ${o.name||''}\nالهاتف: ${o.phone||''}\nالعنوان: ${o.address||''}\n\nالأصناف:\n`;
        let totalValue = 0;
        o.items.forEach(it => {
            const itemValue = parseFloat(it.price || 0) * it.qty;
            totalValue += itemValue;
            text += ` - ${it.name} (كمية: ${it.qty}, السعر: ${it.price || '0'}, القيمة: ${itemValue.toFixed(2)})\n`;
        });
        text += `\nإجمالي الطلب: ${totalValue.toFixed(2)} ر.س`;
        return text;
    }
    
    //======================================================================
    // تم تحديث وظيفة عد الطلبات لجلبها من Supabase
    //======================================================================
    async function updateOrdersCount(){
      const { count, error } = await supabase.from('orders').select('*', { count: 'exact' });
      if(error){
        console.error('Error counting orders:', error);
      } else {
        ordersCount.textContent = `${count} طلب محفوظ`;
      }
    }
    
    // Add / Edit Categories Logic
    addCategoryBtn.addEventListener('click', ()=>{ openCategoryModal('add'); });
    //======================================================================
    // تم تعديل وظيفة حفظ التصنيف
    //======================================================================
    saveCategoryBtn.addEventListener('click', async ()=>{ await saveCategory(); });

    function openCategoryModal(mode, catId = null){
      categoryModal.style.display = 'flex';
      editingCategoryId = catId;
      if(mode === 'add'){
        categoryModalTitle.textContent = 'إضافة تصنيف جديد';
        categoryModalName.value = '';
      } else if (mode === 'edit' && catId){
        categoryModalTitle.textContent = 'تعديل التصنيف';
        const category = catalog.categories.find(c => c.id === catId);
        if(category) categoryModalName.value = category.name;
      }
    }

    async function saveCategory(){
      const newName = categoryModalName.value.trim();
      if(!newName) {
        alert('اسم التصنيف لا يمكن أن يكون فارغاً.');
        return;
      }
      
      let res;
      if (editingCategoryId) { // edit mode
        res = await supabase.from('categories').update({ name: newName }).eq('id', editingCategoryId);
      } else { // add mode
        res = await supabase.from('categories').insert({ name: newName });
      }

      if(res.error){
        console.error('Error saving category:', res.error);
        alert('حدث خطأ أثناء حفظ التصنيف.');
      } else {
        await populateAdmin();
        renderCategories();
        categoryModal.style.display = 'none';
        alert('تم حفظ التصنيف بنجاح!');
      }
    }

    //======================================================================
    // تم تعديل وظيفة حذف التصنيف
    //======================================================================
    async function deleteCategory(catId){
      const { error: itemError } = await supabase.from('items').delete().eq('cat', catId);
      const { error: catError } = await supabase.from('categories').delete().eq('id', catId);

      if(catError || itemError){
        console.error('Error deleting category or items:', catError || itemError);
        alert('حدث خطأ أثناء الحذف.');
      } else {
        await populateAdmin();
        await renderCategories();
        await renderItems();
        alert('تم حذف التصنيف والأصناف التابعة له بنجاح.');
      }
    }
    
    // Add / Edit Items Logic
    openAddItemBtn.addEventListener('click', ()=>{ openItemModal('add'); });
    //======================================================================
    // تم تعديل وظيفة حفظ الصنف
    //======================================================================
    saveItemBtn.addEventListener('click', async ()=>{ await saveItem(); });

    async function openItemModal(mode, itemId = null){
      itemModal.style.display = 'flex';
      editingItemId = itemId;
      
      const { categories } = await fetchCatalog();
      catalog.categories = categories;

      // populate categories select
      itemModalCategory.innerHTML = '';
      catalog.categories.forEach(cat=>{
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.name;
        itemModalCategory.appendChild(opt);
      });
      
      // Set initial values
      if (mode === 'add') {
        itemModalTitle.textContent = 'إضافة صنف جديد';
        itemModalName.value = '';
        itemModalDesc.value = '';
        itemModalPrice.value = '';
        itemModalImage.value = '';
        if(selectCatForItem.value) { itemModalCategory.value = selectCatForItem.value; }
      } else if (mode === 'edit' && itemId) {
        itemModalTitle.textContent = 'تعديل الصنف';
        const item = catalog.items.find(i => i.id === itemId);
        if(item){
          itemModalName.value = item.name;
          itemModalDesc.value = item.desc;
          itemModalPrice.value = item.price;
          itemModalCategory.value = item.cat;
        }
      }
    }
    
    async function saveItem(){
      const name = itemModalName.value.trim();
      const cat = itemModalCategory.value;
      const desc = itemModalDesc.value.trim();
      const price = itemModalPrice.value.trim();
      const imgFile = itemModalImage.files[0];
      
      if(!name || !cat){
        alert('الرجاء إدخال اسم الصنف واختيار التصنيف.');
        return;
      }
      
      let imgData = null;
      if(imgFile){
        imgData = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(imgFile);
        });
      }
      
      let itemPayload = { cat, name, desc, price, img: imgData || '', stock: 999 };
      let res;
      
      if(editingItemId){ // edit mode
        res = await supabase.from('items').update(itemPayload).eq('id', editingItemId);
      } else { // add mode
        res = await supabase.from('items').insert([itemPayload]);
      }

      if(res.error){
        console.error('Error saving item:', res.error);
        alert('حدث خطأ أثناء حفظ الصنف.');
      } else {
        await populateAdmin();
        itemModal.style.display = 'none';
        alert('تم حفظ الصنف بنجاح!');
      }
    }

    function openItemModalForEdit(itemId){
        openItemModal('edit', itemId);
    }
    
    //======================================================================
    // تم تعديل وظيفة حذف الصنف
    //======================================================================
    async function deleteItem(itemId){
      const { error } = await supabase.from('items').delete().eq('id', itemId);

      if(error){
        console.error('Error deleting item:', error);
        alert('حدث خطأ أثناء الحذف.');
      } else {
        await renderItems();
        await populateAdmin();
        alert('تم حذف الصنف بنجاح.');
      }
    }

    //======================================================================
    // وظيفة حذف الطلبات المحفوظة
    //======================================================================
    async function deleteOrder(orderId){
      const { error } = await supabase.from('orders').delete().eq('id', orderId);
      if(error){
        console.error('Error deleting order:', error);
        alert('حدث خطأ أثناء حذف الطلب.');
      } else {
        await populateAdmin();
        alert('تم حذف الطلب بنجاح.');
      }
    }

    // Initial rendering
    document.getElementById('search').addEventListener('keyup', renderItems);
    document.getElementById('btnClear').addEventListener('click', ()=>{ cart=[]; renderOrder(); });
    
    //======================================================================
    // تم تحديث وظائف التهيئة الأولية
    //======================================================================
    async function initializeApp(){
      await renderCategories();
      await renderItems();
      renderOrder();
      await updateOrdersCount();
    }
    
    initializeApp();
  </script>
</body>
</html>